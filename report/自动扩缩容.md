
> âœ… **å®ç°ä¸€ä¸ªæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰çš„å¾®æœåŠ¡éƒ¨ç½²**ï¼Œæ ¹æ®å®æ—¶è´Ÿè½½åŠ¨æ€è°ƒæ•´ Pod å‰¯æœ¬æ•°ã€‚
---
## âœ… å¾®æœåŠ¡è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰å®éªŒæ­¥éª¤
---
### ğŸ“Œ ç¬¬ä¸€æ­¥ï¼šä¸ºç›®æ ‡æœåŠ¡éƒ¨ç½²æŒ‡æ ‡é‡‡é›†ç»„ä»¶ï¼ˆMetrics Serverï¼‰
Kubernetes çš„è‡ªåŠ¨æ‰©ç¼©å®¹ä¾èµ–æŒ‡æ ‡æœåŠ¡å™¨ï¼ˆå¦‚ CPU ä½¿ç”¨ç‡ï¼‰ï¼Œæ‰€ä»¥å¿…é¡»å®‰è£… Metrics Serverã€‚

---
æˆ‘ä»¬å°†ä¸‹è½½ `components.yaml` å¹¶æ‰‹åŠ¨æ·»åŠ å¯åŠ¨å‚æ•°ã€‚
#### 1ï¼‰ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼š
```bash
wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml
```
#### 2ï¼‰ç¼–è¾‘æ–‡ä»¶ï¼Œæ‰¾åˆ° `metrics-server` Deployment æ®µï¼š
æŸ¥æ‰¾ï¼š
```yaml
containers:
  - name: metrics-server
    image: ...
    args:
      - --cert-dir=/tmp
      - --secure-port=4443
```
åœ¨ `args` ä¸‹æ·»åŠ ä¸€è¡Œå‚æ•°ï¼š
```yaml
      - --kubelet-insecure-tls
```
åœ¨æŸäº›é›†ç¾¤ä¸­ï¼ˆç‰¹åˆ«æ˜¯ Minikube æˆ–è£¸æœºï¼‰ï¼Œ`kubelet` ä½¿ç”¨äº†è‡ªç­¾åè¯ä¹¦ï¼Œä¸è¢« Metrics Server ä¿¡ä»»ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªå‚æ•°ç»•è¿‡ TLS æ ¡éªŒã€‚

---
### âœ… æ­¥éª¤ 3ï¼šé‡æ–°åº”ç”¨å®‰è£…
```bash
kubectl apply -f metrics-server.yaml
```
---
### âœ… æ­¥éª¤ 4ï¼šéªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
ç­‰å¾…åå‡ ç§’åï¼Œæ‰§è¡Œï¼š
```bash
kubectl get deployment metrics-server -n kube-system
kubectl top nodes
kubectl top pods
```
`metrics-server` åº”è¯¥å˜æˆ `1/1 READY`ï¼Œ`top` å‘½ä»¤åº”è¿”å›æ•°æ®ã€‚

---
### ğŸ“Œ ç¬¬äºŒæ­¥ï¼šä¸ºç›®æ ‡æœåŠ¡è®¾ç½®èµ„æºè¯·æ±‚ä¸é™åˆ¶
ä»¥ `product` æœåŠ¡ä¸ºä¾‹ï¼Œéœ€ç¡®ä¿å…¶ Deployment ä¸­åŒ…å«èµ„æºé™åˆ¶å­—æ®µï¼š
#### âœï¸ ä¿®æ”¹ `product-deployment.yaml`
åœ¨ `containers` ä¸‹é¢æ·»åŠ ï¼š
```yaml
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi
```
åŒç†ä¿®æ”¹å…¶ä»–yamlæ–‡ä»¶ä¹‹åä¸€é”®é‡æ–°éƒ¨ç½²ï¼š
```bash
kubectl apply -f k8s/microservices/
```
---
### ğŸ“Œ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Horizontal Pod Autoscaler (HPA)
ä½¿ç”¨ CPU åˆ©ç”¨ç‡ä½œä¸ºæ‰©ç¼©å®¹ä¾æ®ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹å‘½ä»¤ï¼š
```bash
kubectl autoscale deployment product --cpu-percent=50 --min=1 --max=5
```
æ­¤å‘½ä»¤è¡¨ç¤ºå½“ CPU ä½¿ç”¨ç‡è¶…è¿‡ 50% æ—¶ï¼Œ`product` æœåŠ¡ä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæœ€å¤šæ‰©åˆ° 5 ä¸ª Podã€‚
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ HPA çŠ¶æ€ï¼š
```bash
kubectl get hpa
```
k8sä¸‹åˆ›å»ºæ–‡ä»¶å¤¹hpaï¼Œåˆ†åˆ«ç¼–å†™æ¯ä¸ªæœåŠ¡çš„hpaæ–‡ä»¶ï¼Œå†ä¸€é”®éƒ¨ç½²
```bash
kubectl apply -f k8s/hpa/
```
---
### ğŸ“Œ ç¬¬å››æ­¥ï¼šåˆ¶é€ è´Ÿè½½ä»¥è§¦å‘æ‰©å®¹
é¦–å…ˆå¯åŠ¨frontendæœåŠ¡å¹¶è½¬å‘ç«¯å£
```bash
kubectl port-forward service/frontend 8080:8080
```
![alt text](graphs/port-foward.png)

ä½¿ç”¨ `hey` è¿›è¡Œå‹æµ‹ï¼š
```bash
hey -z 60s -c 200 http://localhost:8080
```
å†æŸ¥çœ‹å‰¯æœ¬æ•°å˜åŒ–ï¼š
```bash
kubectl get hpa
kubectl get pods -l app=frontend
```
ä½ åº”è¯¥èƒ½çœ‹åˆ° `frontend` çš„å‰¯æœ¬æ•°è‡ªåŠ¨å¢é•¿ã€‚
![alt text](graphs/run.png)

---

### ğŸ“Œ ç¬¬äº”æ­¥ï¼šéªŒè¯è‡ªåŠ¨ç¼©å®¹

åœæ­¢å‹æµ‹åæ‰§è¡Œç›‘æµ‹ï¼š
```bash
watch -n 10 "kubectl get hpa && kubectl get pods -l app=frontend"
```
![alt text](graphs/pods3.png)
![alt text](graphs/pods2.png)
![alt text](graphs/pods1.png)

è§‚å¯Ÿåˆ° Pod å‰¯æœ¬æ•°å‡å°‘è‡³æœ€å°å€¼1ã€‚

---
